name: Starfish Router Workflow

on:
  push:
  pull_request:
    branches: ["main", "development"]

jobs:
  setup-and-run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Create .env file for testing
      run: |
        cat > .env << EOF
        DEBUG=True
        SECRET_KEY=test-secret-key-for-ci
        DATABASE_NAME=starfish-router
        DATABASE_USER=postgres
        DATABASE_PASSWORD=UCalgary123
        DATABASE_HOST=postgres
        DATABASE_PORT=5432
        EOF
    
    - name: Create external docker network
      run: docker network create starfish-network || true
    
    - name: Build images
      run: docker compose build
    
    - name: Start services
      run: docker compose up -d
    
    - name: Wait for PostgreSQL to be ready
      run: |
        echo "Waiting for PostgreSQL to be ready..."
        for i in {1..30}; do
          if docker exec starfish-router-postgres pg_isready -U postgres; then
            echo "PostgreSQL is ready!"
            break
          fi
          echo "Attempt $i: PostgreSQL not ready yet..."
          sleep 2
        done
    
    - name: Run migrations
      run: |
        docker exec starfish-router poetry run python3 manage.py makemigrations
        docker exec starfish-router poetry run python3 manage.py migrate --noinput
    
    - name: Run Django tests
      run: |
        docker exec starfish-router poetry run python3 manage.py test
    
    - name: Wait for application to be ready
      run: |
        echo "Waiting for application to respond..."
        for i in {1..60}; do
          if curl -f http://localhost:8000/starfish/api/v1/ 2>/dev/null; then
            echo "Application is ready!"
            break
          fi
          echo "Attempt $i: Application not ready yet..."
          sleep 2
        done
    
    - name: Test API endpoint
      run: |
        curl -f http://localhost:8000/starfish/api/v1/ || exit 1
    
    - name: Show logs on failure
      if: failure()
      run: docker compose logs
    
    - name: Cleanup
      if: always()
      run: docker compose down -v

  docker-publish:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [setup-and-run-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and publish docker image for ${{ github.repository }}
        uses: macbre/push-to-ghcr@master
        with:
          image_name: ${{ github.repository }}
          github_token: ${{ secrets.GITHUB_TOKEN }}


